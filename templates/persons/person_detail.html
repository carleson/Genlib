{% extends 'base.html' %}

{% block title %}{{ person.get_full_name }} - Genlib{% endblock %}

{% block extra_css %}
<style>
    #bookmark-star {
        cursor: pointer;
        color: #6c757d;
        transition: color 0.2s ease;
    }

    #bookmark-star:hover {
        color: #ffc107;
    }

    #bookmark-star.bookmarked {
        color: #ffc107;
    }

    #bookmark-star.bookmarked:hover {
        color: #ff9800;
    }

    .image-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .image-card img {
        transition: opacity 0.2s ease;
    }

    .image-card img:hover {
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ person.get_full_name }}</h1>
    <div>
        <a href="{% url 'persons:update' person.id %}" class="btn btn-warning">
            <i class="bi bi-pencil"></i> Redigera
        </a>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-tools"></i> Verktyg
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renameModal">
                    <i class="bi bi-pencil-square"></i> Döp om person
                </a></li>
                <li><a class="dropdown-item" href="{% url 'persons:duplicate' person.id %}">
                    <i class="bi bi-files"></i> Duplicera person
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="{% url 'persons:set_main_person' person.id %}"
                       onclick="return confirm('Vill du ange {{ person.get_full_name }} som huvudperson?');">
                        <i class="bi bi-person-badge"></i> Ange som huvudperson
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form method="post" action="{% url 'persons:sync_documents' person.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item" onclick="return confirm('Detta kommer att synkronisera dokument från filsystemet. Vill du fortsätta?');">
                            <i class="bi bi-arrow-repeat"></i> Ladda om dokument
                        </button>
                    </form>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'persons:export' person.id %}">
                    <i class="bi bi-download"></i> Exportera data
                </a></li>
                <li><a class="dropdown-item" href="{% url 'persons:chronological_report' person.id %}">
                    <i class="bi bi-calendar3"></i> Kronologisk rapport
                </a></li>
            </ul>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-archive"></i> Arkiv
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="https://sok.riksarkivet.se/?Sokord=&f=True&EndastDigitaliserat=false&TranskriberadText=false&Fritext=&Namn={{ person.firstname|urlencode }}+{{ person.surname|urlencode }}&Ort=&DatumFran=&DatumTill=&AvanceradSok=true" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i> Riksarkivet
                </a></li>
                <li><a class="dropdown-item" href="https://app.arkivdigital.se/register-collections/register-posts?query={{ person.firstname|urlencode }}%20{{ person.surname|urlencode }}{% if person.birth_date %}%20{{ person.birth_date|date:"Y-m-d"|urlencode }}{% endif %}&register_collection=29" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i> Sveriges befolkning 1940-1990 (AD)
                </a></li>
            </ul>
        </div>
        <a href="{% url 'persons:delete' person.id %}" class="btn btn-danger">
            <i class="bi bi-trash"></i> Ta bort
        </a>
        <a href="{% url 'persons:list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Tillbaka
        </a>
    </div>
</div>

<!-- Personinformation -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-person"></i> Personuppgifter</span>
                <button id="bookmark-star"
                        class="btn btn-link p-0 text-decoration-none {% if is_bookmarked %}bookmarked{% endif %}"
                        data-person-id="{{ person.id }}"
                        title="{% if is_bookmarked %}Ta bort bokmärke{% else %}Lägg till bokmärke{% endif %}">
                    <i class="bi {% if is_bookmarked %}bi-star-fill{% else %}bi-star{% endif %}" style="font-size: 1.5rem;"></i>
                </button>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Förnamn:</dt>
                    <dd class="col-sm-9">{{ person.firstname|default:"-" }}</dd>

                    <dt class="col-sm-3">Efternamn:</dt>
                    <dd class="col-sm-9">{{ person.surname|default:"-" }}</dd>

                    <dt class="col-sm-3">Födelsedatum:</dt>
                    <dd class="col-sm-9">{{ person.birth_date|date:"Y-m-d"|default:"-" }}</dd>

                    <dt class="col-sm-3">Dödsdatum:</dt>
                    <dd class="col-sm-9">{{ person.death_date|date:"Y-m-d"|default:"-" }}</dd>

                    {% if person.age %}
                    <dt class="col-sm-3">Ålder:</dt>
                    <dd class="col-sm-9">
                        <span class="badge bg-primary">{{ person.age }} år</span>
                        {% if person.death_date %}
                            <small class="text-muted">(vid döden)</small>
                        {% else %}
                            <small class="text-muted">(nuvarande)</small>
                        {% endif %}
                    </dd>
                    {% endif %}

                    <dt class="col-sm-3">Katalognamn:</dt>
                    <dd class="col-sm-9"><code>{{ person.directory_name }}</code></dd>

                    <dt class="col-sm-3">Katalogsökväg:</dt>
                    <dd class="col-sm-9">
                        <code class="text-primary">{{ person.get_full_directory_path }}</code>
                        <button type="button"
                                class="btn btn-sm btn-outline-primary ms-2"
                                onclick="openDirectoryBrowser({{ person.id }}, '{{ person.get_full_directory_path|escapejs }}')"
                                title="Öppna katalog">
                            <i class="bi bi-folder2-open"></i>
                        </button>
                    </dd>

                    <dt class="col-sm-3">Mall använd:</dt>
                    <dd class="col-sm-9">{{ person.template_used.name|default:"-" }}</dd>

                    <dt class="col-sm-3">Skapad:</dt>
                    <dd class="col-sm-9">{{ person.created_at|date:"Y-m-d H:i" }}</dd>

                    <dt class="col-sm-3">Uppdaterad:</dt>
                    <dd class="col-sm-9">{{ person.updated_at|date:"Y-m-d H:i" }}</dd>
                </dl>

                {% if person.notes %}
                <hr>
                <h5>Anteckningar:</h5>
                <p class="text-muted">{{ person.notes|linebreaks }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        {% if person.profile_image %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-card-image"></i> Foto
            </div>
            <div class="card-body text-center">
                <img src="{{ person.profile_image.get_file_url }}"
                     alt="{{ person.get_full_name }}"
                     class="img-thumbnail"
                     style="max-width: 150px; max-height: 150px; object-fit: cover; cursor: pointer;"
                     data-bs-toggle="modal"
                     data-bs-target="#imageModal"
                     data-image-url="{{ person.profile_image.get_file_url }}"
                     data-image-id="{{ person.profile_image.id }}"
                     data-image-name="{{ person.profile_image.filename }}"
                     data-image-tags="{{ person.profile_image.tags }}"
                     data-image-size="{{ person.profile_image.file_size|filesizeformat }}">
                <div class="mt-1">
                    <strong>{{ person.get_full_name }}</strong>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Statistik
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-6">Dokument:</dt>
                    <dd class="col-sm-6 text-end">
                        <span class="badge bg-info">{{ total_documents }}</span>
                    </dd>

                    <dt class="col-sm-6">Bilder:</dt>
                    <dd class="col-sm-6 text-end">
                        <span class="badge bg-primary">{{ total_images }}</span>
                    </dd>

                    <dt class="col-sm-6">Total storlek:</dt>
                    <dd class="col-sm-6 text-end">{{ total_size|filesizeformat }}</dd>

                    <dt class="col-sm-6">Relationer:</dt>
                    <dd class="col-sm-6 text-end">
                        <span class="badge bg-success">{{ total_relationships }}</span>
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Bildgalleri -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-images"></i> Bilder</span>
        <div>
            <button type="button" class="btn btn-sm btn-info" onclick="syncImages()">
                <i class="bi bi-arrow-repeat"></i> Ladda om bildarkiv
            </button>
            <button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById('imageUploadInput').click()">
                <i class="bi bi-plus"></i> Lägg till bilder
            </button>
        </div>
    </div>
    <div class="card-body">
        {% if images %}
            <div class="row g-3">
                {% for image in images %}
                <div class="col-md-3 col-sm-4 col-6">
                    <div class="card h-100 image-card">
                        <div class="position-relative">
                            <img src="{{ image.get_file_url }}"
                                 class="card-img-top"
                                 alt="{{ image.filename }}"
                                 style="width: 150px; height: 150px; object-fit: cover; cursor: pointer; margin: 0 auto; display: block;"
                                 data-bs-toggle="modal"
                                 data-bs-target="#imageModal"
                                 data-image-url="{{ image.get_file_url }}"
                                 data-image-id="{{ image.id }}"
                                 data-image-name="{{ image.filename }}"
                                 data-image-tags="{{ image.tags }}"
                                 data-image-size="{{ image.file_size|filesizeformat }}">
                            {% if person.profile_image and person.profile_image.id == image.id %}
                            <span class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-success">
                                    <i class="bi bi-star-fill"></i> Huvudbild
                                </span>
                            </span>
                            {% endif %}
                        </div>
                        <div class="card-body p-2">
                            <p class="card-text small mb-1 text-truncate" title="{{ image.filename }}">
                                {{ image.filename }}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">{{ image.file_size|filesizeformat }}</small>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'documents:view' image.id %}"
                                       class="btn btn-outline-primary btn-sm"
                                       title="Öppna">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-outline-warning btn-sm"
                                            onclick="setAsProfileImage({{ image.id }})"
                                            title="Sätt som huvudbild"
                                            {% if person.profile_image and person.profile_image.id == image.id %}disabled{% endif %}>
                                        <i class="bi bi-star"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-danger btn-sm"
                                            onclick="deleteImage({{ image.id }}, '{{ image.filename|escapejs }}')"
                                            title="Ta bort">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted mb-0">
                Inga bilder ännu. <a href="#" onclick="document.getElementById('imageUploadInput').click(); return false;">Lägg till första bilden!</a>
            </p>
            <p class="text-muted mt-2">
                <small><i class="bi bi-info-circle"></i> Tips: Du kan också lägga bilder direkt i personens katalog och sedan klicka på "Ladda om bildarkiv".</small>
            </p>
        {% endif %}
    </div>
</div>

<!-- Dolt formulär för bilduppladdning -->
<form id="imageUploadForm" method="post" action="{% url 'persons:upload_images' person.id %}" enctype="multipart/form-data" style="display: none;">
    {% csrf_token %}
    <input type="file" id="imageUploadInput" name="images" accept="image/*" multiple onchange="handleImageUpload()">
</form>

<!-- Checklista -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-check2-square"></i> Checklista</span>
        <a href="{% url 'persons:checklist' person.id %}" class="btn btn-sm btn-primary">
            <i class="bi bi-list-check"></i> Visa fullständig checklista
        </a>
    </div>
    <div class="card-body">
        {% if total_checklist_items > 0 %}
            {% widthratio completed_checklist_items total_checklist_items 100 as percentage %}
            <div class="progress mb-2" style="height: 25px;">
                <div class="progress-bar bg-success" role="progressbar"
                     style="width: {{ percentage }}%;"
                     aria-valuenow="{{ percentage }}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                    {{ percentage }}%
                </div>
            </div>
            <p class="text-muted mb-0">
                {{ completed_checklist_items }} av {{ total_checklist_items }} objekt avklarade
            </p>
        {% else %}
            <p class="text-muted mb-0">Ingen checklista har lagts till ännu.</p>
        {% endif %}
    </div>
</div>

<!-- Relationships -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-diagram-3"></i> Relationer</span>
        <a href="{% url 'persons:relationship_create' person.id %}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus"></i> Lägg till relation
        </a>
    </div>
    <div class="card-body">
        {% if total_relationships > 0 %}
            <div class="row">
                {% if relationships_grouped.parents %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="bi bi-arrow-up-circle"></i> Föräldrar</h6>
                    <ul class="list-group">
                        {% for related_person, rel in relationships_grouped.parents %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'persons:detail' related_person.id %}" class="text-decoration-none">
                                {{ related_person.get_full_name }}
                            </a>
                            <a href="{% url 'persons:relationship_delete' rel.id %}"
                               class="btn btn-sm btn-outline-danger" title="Ta bort relation">
                                <i class="bi bi-trash"></i>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if relationships_grouped.children %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="bi bi-arrow-down-circle"></i> Barn</h6>
                    <ul class="list-group">
                        {% for related_person, rel in relationships_grouped.children %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'persons:detail' related_person.id %}" class="text-decoration-none">
                                {{ related_person.get_full_name }}
                            </a>
                            <a href="{% url 'persons:relationship_delete' rel.id %}"
                               class="btn btn-sm btn-outline-danger" title="Ta bort relation">
                                <i class="bi bi-trash"></i>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if relationships_grouped.spouses %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="bi bi-heart"></i> Make/Maka</h6>
                    <ul class="list-group">
                        {% for related_person, rel in relationships_grouped.spouses %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'persons:detail' related_person.id %}" class="text-decoration-none">
                                {{ related_person.get_full_name }}
                            </a>
                            <a href="{% url 'persons:relationship_delete' rel.id %}"
                               class="btn btn-sm btn-outline-danger" title="Ta bort relation">
                                <i class="bi bi-trash"></i>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if relationships_grouped.siblings %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="bi bi-people"></i> Syskon</h6>
                    <ul class="list-group">
                        {% for related_person, rel in relationships_grouped.siblings %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'persons:detail' related_person.id %}" class="text-decoration-none">
                                {{ related_person.get_full_name }}
                            </a>
                            <a href="{% url 'persons:relationship_delete' rel.id %}"
                               class="btn btn-sm btn-outline-danger" title="Ta bort relation">
                                <i class="bi bi-trash"></i>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        {% else %}
            <p class="text-muted mb-0">
                Inga relationer ännu. <a href="{% url 'persons:relationship_create' person.id %}">Lägg till den första relationen!</a>
            </p>
        {% endif %}
    </div>
</div>

<!-- Dokument -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-file-earmark-text"></i> Dokument</span>
        <a href="{% url 'documents:create' %}?person={{ person.id }}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus"></i> Lägg till dokument
        </a>
    </div>
    <div class="card-body">
        {% if documents %}
            {% if documents_by_type %}
                {% for type_name, docs in documents_by_type.items %}
                <h5 class="mt-3 mb-2">{{ type_name }}</h5>
                <div class="list-group mb-3">
                    {% for doc in docs %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">
                                    {{ doc.filename }}
                                    {% if not doc.file %}
                                    <span class="badge bg-warning text-dark">Ingen fil</span>
                                    {% endif %}
                                </h6>
                                <small class="text-muted">
                                    {% if doc.file_type %}
                                    <span class="badge bg-secondary">{{ doc.file_type|upper }}</span>
                                    {% endif %}
                                    {% if doc.file %}
                                    {{ doc.get_file_size_display }}
                                    {% endif %}
                                    {% if doc.tags %}
                                    <br>Taggar: {{ doc.tags|truncatewords:10 }}
                                    {% endif %}
                                </small>
                            </div>
                            <div>
                                <a href="{% url 'documents:view' doc.id %}" class="btn btn-sm btn-primary" title="Öppna">
                                    <i class="bi bi-eye"></i> Öppna
                                </a>
                                {% if doc.file %}
                                <a href="{% url 'documents:download' doc.id %}" class="btn btn-sm btn-success" title="Ladda ner">
                                    <i class="bi bi-download"></i> Ladda ner
                                </a>
                                {% endif %}
                                <a href="{% url 'documents:delete' doc.id %}" class="btn btn-sm btn-danger" title="Ta bort">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% endif %}
        {% else %}
        <p class="text-muted mb-0">
            Inga dokument ännu. <a href="{% url 'documents:create' %}?person={{ person.id }}">Lägg till det första dokumentet!</a>
        </p>
        {% endif %}
    </div>
</div>

<!-- Modal: Döp om person -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'persons:rename' person.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="renameModalLabel">Döp om person</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Varning:</strong> Detta kommer att döpa om katalogen i filsystemet.
                    </div>
                    <div class="mb-3">
                        <label for="rename_firstname" class="form-label fw-bold">Förnamn</label>
                        <input type="text" name="firstname" class="form-control"
                               value="{{ person.firstname }}" id="rename_firstname">
                    </div>
                    <div class="mb-3">
                        <label for="rename_surname" class="form-label fw-bold">Efternamn</label>
                        <input type="text" name="surname" class="form-control"
                               value="{{ person.surname }}" id="rename_surname">
                    </div>
                    <div class="mb-3">
                        <label for="rename_directory_name" class="form-label fw-bold">Nytt katalognamn (genereras automatiskt)</label>
                        <input type="text" name="new_directory_name" class="form-control"
                               readonly id="rename_directory_name">
                    </div>
                    <div class="form-text">
                        <strong>Nuvarande katalog:</strong> <code>{{ person.directory_name }}</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-pencil-square"></i> Döp om
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Image Viewer -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">
                    <i class="bi bi-image"></i> <span id="modal-image-name"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-image" src="" alt="" class="img-fluid" style="max-height: 70vh;">

                <div class="mt-3">
                    <dl class="row">
                        <dt class="col-sm-3">Filnamn:</dt>
                        <dd class="col-sm-9 text-start" id="modal-image-filename"></dd>

                        <dt class="col-sm-3">Storlek:</dt>
                        <dd class="col-sm-9 text-start" id="modal-image-size"></dd>

                        <dt class="col-sm-3">Taggar:</dt>
                        <dd class="col-sm-9 text-start" id="modal-image-tags"></dd>
                    </dl>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-warning"
                        id="modal-set-profile-btn"
                        onclick="setAsProfileImageFromModal()">
                    <i class="bi bi-star"></i> Sätt som huvudbild
                </button>
                <a href="#" id="modal-edit-btn" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Redigera
                </a>
                <button type="button"
                        class="btn btn-danger"
                        id="modal-delete-btn"
                        onclick="deleteImageFromModal()">
                    <i class="bi bi-trash"></i> Ta bort
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
            </div>
        </div>
    </div>
</div>

<!-- File Browser Modal -->
<div class="modal fade" id="fileBrowserModal" tabindex="-1" aria-labelledby="fileBrowserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="fileBrowserModalLabel">
                    <i class="bi bi-folder2-open"></i> Filbläddrare
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body" id="fileBrowserContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="mt-2">Hämtar filer...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-generera katalognamn i rename modal
document.addEventListener('DOMContentLoaded', function() {
    const firstnameInput = document.getElementById('rename_firstname');
    const surnameInput = document.getElementById('rename_surname');
    const directoryNameInput = document.getElementById('rename_directory_name');
    const birthDate = '{{ person.birth_date|date:"Y-m-d"|default:"" }}';

    function generateDirectoryName() {
        const firstname = firstnameInput.value.trim().toLowerCase().replace(/\s+/g, '_').replace(/[åä]/g, 'a').replace(/ö/g, 'o');
        const surname = surnameInput.value.trim().toLowerCase().replace(/\s+/g, '_').replace(/[åä]/g, 'a').replace(/ö/g, 'o');

        let directoryName = '';
        if (firstname && surname) {
            directoryName = firstname + '_' + surname;
        } else if (firstname) {
            directoryName = firstname;
        } else if (surname) {
            directoryName = surname;
        }

        if (birthDate) {
            directoryName = directoryName ? directoryName + '_' + birthDate : birthDate;
        }

        directoryNameInput.value = directoryName;
    }

    if (firstnameInput && surnameInput) {
        firstnameInput.addEventListener('input', generateDirectoryName);
        surnameInput.addEventListener('input', generateDirectoryName);
        // Generera initialt värde
        generateDirectoryName();
    }

    // Bokmärkesfunktionalitet
    const bookmarkStar = document.getElementById('bookmark-star');
    if (bookmarkStar) {
        bookmarkStar.addEventListener('click', function(e) {
            e.preventDefault();
            const personId = this.dataset.personId;
            const icon = this.querySelector('i');
            const button = this;

            // Anropa backend för att toggle bokmärke
            fetch(`/persons/${personId}/toggle-bookmark/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Uppdatera UI
                    if (data.is_bookmarked) {
                        icon.classList.remove('bi-star');
                        icon.classList.add('bi-star-fill');
                        button.classList.add('bookmarked');
                        button.title = 'Ta bort bokmärke';
                    } else {
                        icon.classList.remove('bi-star-fill');
                        icon.classList.add('bi-star');
                        button.classList.remove('bookmarked');
                        button.title = 'Lägg till bokmärke';
                    }
                }
            })
            .catch(error => {
                console.error('Fel vid toggle av bokmärke:', error);
            });
        });
    }

    // Hjälpfunktion för att hämta CSRF-token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Image Gallery functionality
    const imageModal = document.getElementById('imageModal');
    if (imageModal) {
        imageModal.addEventListener('show.bs.modal', function (event) {
            const trigger = event.relatedTarget;
            const imageUrl = trigger.getAttribute('data-image-url');
            const imageName = trigger.getAttribute('data-image-name');
            const imageId = trigger.getAttribute('data-image-id');
            const imageTags = trigger.getAttribute('data-image-tags') || '-';
            const imageSize = trigger.getAttribute('data-image-size');

            // Update modal content
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('modal-image').alt = imageName;
            document.getElementById('modal-image-name').textContent = imageName;
            document.getElementById('modal-image-filename').textContent = imageName;
            document.getElementById('modal-image-size').textContent = imageSize;
            document.getElementById('modal-image-tags').textContent = imageTags;

            // Update edit button link
            document.getElementById('modal-edit-btn').href = `/documents/${imageId}/`;

            // Store image ID for set profile button
            document.getElementById('modal-set-profile-btn').dataset.imageId = imageId;

            // Store image ID and name for delete button
            document.getElementById('modal-delete-btn').dataset.imageId = imageId;
            document.getElementById('modal-delete-btn').dataset.imageName = imageName;

            // Disable profile button if already profile image
            const isProfileImage = {{ person.profile_image.id|default:'null' }} == imageId;
            document.getElementById('modal-set-profile-btn').disabled = isProfileImage;
            if (isProfileImage) {
                document.getElementById('modal-set-profile-btn').innerHTML =
                    '<i class="bi bi-star-fill"></i> Detta är huvudbilden';
            } else {
                document.getElementById('modal-set-profile-btn').innerHTML =
                    '<i class="bi bi-star"></i> Sätt som huvudbild';
            }
        });
    }
});

// Set image as profile image
function setAsProfileImage(imageId) {
    if (!confirm('Vill du sätta denna bild som huvudbild?')) {
        return;
    }

    fetch(`/persons/{{ person.id }}/set-profile-image/${imageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to show updated profile image
            location.reload();
        } else {
            alert('Fel: ' + (data.error || 'Kunde inte sätta huvudbild'));
        }
    })
    .catch(error => {
        console.error('Fel vid sättning av huvudbild:', error);
        alert('Ett fel uppstod vid sättning av huvudbild');
    });
}

// Set profile image from modal
function setAsProfileImageFromModal() {
    const imageId = document.getElementById('modal-set-profile-btn').dataset.imageId;
    if (imageId) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        modal.hide();

        // Set as profile
        setAsProfileImage(imageId);
    }
}

// Sync images (reuse document sync)
function syncImages() {
    if (!confirm('Detta kommer att synkronisera bilder från filsystemet. Vill du fortsätta?')) {
        return;
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "persons:sync_documents" person.id %}';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');

    form.appendChild(csrfInput);
    document.body.appendChild(form);
    form.submit();
}

// Handle image upload
function handleImageUpload() {
    const input = document.getElementById('imageUploadInput');
    const files = input.files;

    if (files.length === 0) {
        return;
    }

    // Visa antal valda filer
    const fileCount = files.length;
    const message = fileCount === 1 ? '1 bild' : `${fileCount} bilder`;

    if (confirm(`Vill du ladda upp ${message}?`)) {
        // Skicka formuläret
        document.getElementById('imageUploadForm').submit();
    } else {
        // Återställ filväljaren om användaren avbryter
        input.value = '';
    }
}

// Delete image
function deleteImage(imageId, imageName) {
    if (!confirm(`Är du säker på att du vill ta bort bilden "${imageName}"?`)) {
        return;
    }

    fetch(`/persons/{{ person.id }}/delete-image/${imageId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to show updated gallery
            location.reload();
        } else {
            alert('Fel: ' + (data.error || 'Kunde inte ta bort bilden'));
        }
    })
    .catch(error => {
        console.error('Fel vid borttagning av bild:', error);
        alert('Ett fel uppstod vid borttagning av bilden');
    });
}

// Delete image from modal
function deleteImageFromModal() {
    const imageId = document.getElementById('modal-delete-btn').dataset.imageId;
    const imageName = document.getElementById('modal-delete-btn').dataset.imageName;

    if (imageId) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        modal.hide();

        // Delete image
        deleteImage(imageId, imageName);
    }
}

// Helper function to get CSRF token (used by image gallery functions)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// File browser functionality
function isLocalhost() {
    const hostname = window.location.hostname;
    return hostname === 'localhost' ||
           hostname === '127.0.0.1' ||
           hostname === '::1' ||
           hostname === '[::1]';
}

function openDirectoryBrowser(personId, directoryPath) {
    if (isLocalhost()) {
        // Localhost: Open system file explorer
        openSystemFileExplorer(personId, directoryPath);
    } else {
        // Remote: Show modal with file list
        showFileBrowserModal(personId, directoryPath);
    }
}

function openSystemFileExplorer(personId, directoryPath) {
    fetch(`/persons/${personId}/open-file-explorer/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show brief success notification
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        } else {
            alert('Fel: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ett fel uppstod vid öppning av filutforskaren.');
    });
}

function showFileBrowserModal(personId, directoryPath) {
    const modal = new bootstrap.Modal(document.getElementById('fileBrowserModal'));
    const content = document.getElementById('fileBrowserContent');

    // Reset to loading state
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laddar...</span>
            </div>
            <p class="mt-2">Hämtar filer...</p>
        </div>
    `;

    modal.show();

    // Fetch file list
    fetch(`/persons/${personId}/list-files/`)
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Kunde inte hämta filer');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.files.length === 0) {
                content.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Inga filer hittades i katalogen.
                    </div>
                    <p class="text-muted"><strong>Sökväg:</strong> <code>${escapeHtml(data.directory_path)}</code></p>
                `;
                return;
            }

            // Build file list
            let html = `
                <div class="mb-3">
                    <strong>Sökväg:</strong> <code class="text-primary">${escapeHtml(data.directory_path)}</code>
                </div>
                <div class="list-group" style="max-height: 500px; overflow-y: auto;">
            `;

            data.files.forEach(file => {
                const icon = file.is_dir ? 'bi-folder-fill text-warning' : getFileIcon(file.name);
                const sizeText = file.is_dir ? '&lt;DIR&gt;' : formatFileSize(file.size);
                const modifiedDate = new Date(file.modified * 1000).toLocaleString('sv-SE');

                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <i class="bi ${icon} me-2"></i>
                                <strong>${escapeHtml(file.name)}</strong>
                                ${file.relative_path !== file.name ? `<br><small class="text-muted ms-4">${escapeHtml(file.relative_path)}</small>` : ''}
                            </div>
                            <div class="text-end text-muted small" style="min-width: 200px;">
                                <div>${sizeText}</div>
                                <div>${modifiedDate}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            content.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Fel:</strong> ${escapeHtml(error.message)}
                </div>
            `;
        });
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const iconMap = {
        'jpg': 'bi-file-earmark-image text-primary',
        'jpeg': 'bi-file-earmark-image text-primary',
        'png': 'bi-file-earmark-image text-primary',
        'gif': 'bi-file-earmark-image text-primary',
        'bmp': 'bi-file-earmark-image text-primary',
        'webp': 'bi-file-earmark-image text-primary',
        'pdf': 'bi-file-earmark-pdf text-danger',
        'doc': 'bi-file-earmark-word text-primary',
        'docx': 'bi-file-earmark-word text-primary',
        'xls': 'bi-file-earmark-excel text-success',
        'xlsx': 'bi-file-earmark-excel text-success',
        'txt': 'bi-file-earmark-text text-secondary',
        'zip': 'bi-file-earmark-zip text-warning',
        'rar': 'bi-file-earmark-zip text-warning',
    };
    return iconMap[ext] || 'bi-file-earmark text-secondary';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
